<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบประเมินภาวะซึมเศร้า (PHQ-9) </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <style>
        .kanit-thin {
            font-family: "Kanit", sans-serif;
            font-weight: 100;
            font-style: normal;
        }

        .kanit-extralight {
            font-family: "Kanit", sans-serif;
            font-weight: 200;
            font-style: normal;
        }

        .kanit-light {
            font-family: "Kanit", sans-serif;
            font-weight: 300;
            font-style: normal;
        }

        .kanit-regular {
            font-family: "Kanit", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        .kanit-medium {
            font-family: "Kanit", sans-serif;
            font-weight: 500;
            font-style: normal;
        }

        .kanit-semibold {
            font-family: "Kanit", sans-serif;
            font-weight: 600;
            font-style: normal;
        }

        .kanit-bold {
            font-family: "Kanit", sans-serif;
            font-weight: 700;
            font-style: normal;
        }

        .kanit-extrabold {
            font-family: "Kanit", sans-serif;
            font-weight: 800;
            font-style: normal;
        }

        .kanit-black {
            font-family: "Kanit", sans-serif;
            font-weight: 900;
            font-style: normal;
        }

        .kanit-thin-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 100;
            font-style: italic;
        }

        .kanit-extralight-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 200;
            font-style: italic;
        }

        .kanit-light-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 300;
            font-style: italic;
        }

        .kanit-regular-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 400;
            font-style: italic;
        }

        .kanit-medium-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 500;
            font-style: italic;
        }

        .kanit-semibold-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 600;
            font-style: italic;
        }

        .kanit-bold-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 700;
            font-style: italic;
        }

        .kanit-extrabold-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 800;
            font-style: italic;
        }

        .kanit-black-italic {
            font-family: "Kanit", sans-serif;
            font-weight: 900;
            font-style: italic;
        }


        h2,
        h3,
        label,
        button {
            font-family: 'Kanit', sans-serif;
            color: #003366;
            /* หัวข้อสีฟ้าเข้ม */
        }

        h1 {
            font-family: 'Kanit', sans-serif;
            font-weight: 700;
        }

        p {
            font-family: 'Kanit', sans-serif;
            font-weight: 400;
        }

        /* กำหนดธีมสีใหม่ */
        body {
            background-color: #90EE90;
            /* พื้นหลังสีฟ้าอ่อน */
            color: #000000;
            /* อักษรสีขาว */
            font-family: 'Kanit', sans-serif;

        }


        a {
            color: #8B0000;
            /* ลิงก์สีแดงเข้ม */
        }

        .bt-custom {
            color: #000;
            border: solid 2px #fff;
            box-shadow: #000 2px 2px 1px;
            border-radius: 0.75em;
        }

        .c-loader {
            animation: is-rotating 1s infinite;
            width: 50px;
            height: 50px;
            border: solid 10px #dddddd;
            border-top-color: #07e0ae;
            border-radius: 50%;
        }

        @keyframes is-rotating {
            to {
                transform: rotate(1turn);
            }
        }
    </style>
</head>

<body class="bg-[#90EE90]">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold text-center mb-6">ประเมินภาวะซึมเศร้า (PHQ-9) </h1>
        <!-- คำถามหรือหน้าแนะนำ -->
        <div id="question-container" class="bg-white p-6 rounded-lg shadow-md">
            <!-- เนื้อหาจะถูก inject ด้วย JavaScript -->
            <div class="c-loader"></div>
        </div>
        <!-- ปุ่มนำทาง -->
        <div class="flex justify-between mt-6">
            <button id="prevButton" class="bg-gray-300 bt-custom px-4 py-2 disabled:opacity-50"
                disabled>ย้อนกลับ</button>
            <button id="nextButton" class="bt-custom px-4 py-2 ">ถัดไป</button>
        </div>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const questions = [
            { id: "question1", text: "เบื่อ ไม่สนใจอยากทำอะไร" },
            { id: "question2", text: "ไม่สบายใจ ซึ่งเศร้า ท้อแท้" },
            { id: "question3", text: "หลับยาก หรือ หลับๆ ตื่นๆ หรือหลับมากไป" },
            { id: "question4", text: "เหนื่อยง่าย หรือไม่ค่อยมีแรง" },
            { id: "question5", text: "เบื่ออาหาร หรือ กินมากเกินไป" },
            { id: "question6", text: "รู้สึกไม่ดีกับตัวเอง คิดว่าตนเองล้มเหลว หรือ ทำให้ตนเองหรือครอบครัวผิดหวัง" },
            { id: "question7", text: "สมาธิไม่ดีเวลาทำอะไร เช่น ดูโทรทัศน์ ฟังวิทยุ หรือทำงาน ที่ต้องใช้ความต้องการ" },
            { id: "question8", text: "พูดช้า ทำอะไรช้าลงจนคนอื่นสังเกตเห็นได้ หรือ กระสับกระส่ายไม่สามารถอยู่นิ่งได้เหมือนที่เคยเป็น" },
            { id: "question9", text: "คิดทำร้ายตนเอง หรือคิดว่าถ้าตายไปคงจะดี" }
        ];

        let currentPage = -1; // เริ่มจากหน้าแนะนำ (-1)
        const answers = {}; // เก็บคำตอบ

        // โหลดหน้าแนะนำหรือคำถาม
        function loadPage(page) {
            const container = document.getElementById('question-container');
            const nextButton = document.getElementById('nextButton');
            const prevButton = document.getElementById('prevButton');

            if (page === -1) {
                // หน้าแนะนำ
                container.innerHTML = `
                    <h2 class="text-lg font-semibold mb-4">คำชี้แจง</h2>
                    <p class="text-gray-700">ใน 2 สัปดาห์ที่ผ่านมา รวมวันนี้ คุณรู้สึกอย่างไร?...<br>โดยเลือกคำตอบที่ตรงกับความรู้สึกของคุณมากที่สุด</p>
                `;
                nextButton.textContent = 'เริ่มต้น';
                prevButton.disabled = true;
            } else {
                // หน้าคำถาม

                const question = questions[page];
                container.innerHTML = `
                    <h2 class="text-lg font-semibold mb-4">ข้อที่ ${page + 1}: ${question.text}</h2>
                    <div class="space-y-2">
                        <label class="block"><input type="radio" name="${question.id}" value="0" class="mr-2"> ไม่เลย </label>
                        <label class="block"><input type="radio" name="${question.id}" value="1" class="mr-2"> เล็กน้อย </label>
                        <label class="block"><input type="radio" name="${question.id}" value="2" class="mr-2"> ปานกลาง </label>
                        <label class="block"><input type="radio" name="${question.id}" value="3" class="mr-2"> มาก </label>
                    </div>
                `;
                nextButton.textContent = page === questions.length - 1 ? 'ส่งคำตอบ' : 'ถัดไป';
                prevButton.disabled = page === 0; // ปิดปุ่มย้อนกลับที่คำถามแรก
            }
        }

        // บันทึกคำตอบ
        function saveAnswer() {
            if (currentPage >= 0) {
                const questionId = questions[currentPage].id;
                const selected = document.querySelector(`input[name="${questionId}"]:checked`);
                if (selected) {
                    answers[questionId] = parseInt(selected.value);
                }
            }
        }

        // เริ่มต้น LIFF
        let profilePictureUrl = 'https://via.placeholder.com/200';
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2006670422-P9AYeln9' });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    const idToken = liff.getDecodedIDToken();
                    console.log('ID Token:', idToken); // ดูว่ามีฟิลด์ sub หรือไม่
                    if (!idToken?.sub) {
                        console.error('No sub field in ID Token');
                    }
                    profilePictureUrl = profile.pictureUrl || 'https://via.placeholder.com/200';
                    if (!liff.isInClient()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาเปิดใน LINE',
                            text: 'โปรดเปิดลิงก์นี้ผ่านแอปพลิเคชัน LINE'
                        });
                    }
                    loadPage(currentPage); // โหลดหน้าแนะนำ
                }
            } catch (error) {
                console.error('LIFF Error:', error);
                Swal.fire({ icon: 'error', title: 'ไม่สามารถเชื่อมต่อ LINE ได้', text: error.message });
            }
        }

        // ปุ่มถัดไป
        document.getElementById('nextButton').addEventListener('click', async () => {
            if (currentPage >= 0) {
                saveAnswer();
                if (!answers[questions[currentPage].id] && answers[questions[currentPage].id] !== 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'กรุณาตอบคำถาม',
                        text: 'คุณยังไม่ได้เลือกคำตอบ'
                    });
                    return;
                }
            }

            if (currentPage < questions.length - 1) {
                currentPage++;
                loadPage(currentPage);
            } else if (currentPage === questions.length - 1) {
                // ส่งข้อมูลเมื่อถึงหน้าสุดท้าย
                const totalScore = Object.values(answers).reduce((sum, val) => sum + val, 0);
                const profile = await liff.getProfile();
                const userId = profile.userId;
                const data = {
                    userId: userId || 'unknown',
                    question1: answers.question1,
                    question2: answers.question2,
                    question3: answers.question3,
                    question4: answers.question4,
                    question5: answers.question5,
                    question6: answers.question6,
                    question7: answers.question7,
                    question8: answers.question8,
                    question9: answers.question9,
                    totalScore: totalScore
                };

                const scriptURL = 'https://script.google.com/macros/s/AKfycbxiunGNFoAZ_PaRoyqgO2iSN5n-Ql86J0vHhGu1WpUN24tsZnJnz4XX-0v_Zmy7s2xCBQ/exec';

                try {
                    await fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    sendFlexMessage(totalScore);
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งคำตอบสำเร็จ!',
                        text: 'ผลคะแนนของคุณได้ถูกส่งไปยังแชทแล้ว'
                    }).then(() => liff.closeWindow());
                } catch (error) {
                    console.error('Fetch Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่'
                    });
                }
            }
        });

        // ปุ่มย้อนกลับ
        document.getElementById('prevButton').addEventListener('click', () => {
            saveAnswer();
            if (currentPage > -1) {
                currentPage--;
                loadPage(currentPage);
            }
        });
        // ส่ง Flex Message (ไม่เปลี่ยนแปลง)
        async function sendFlexMessage(totalScore) {
            const level = totalScore <= 6 ? "ต่ำ" : totalScore <= 12 ? "ปานกลาง" : totalScore <= 18 ? "สูง" : "สูงมาก";
            let vbackgroundColor = level === "ต่ำ" ? "#90EE90" : level === "ปานกลาง" ? "#FFC100" : level === "สูง" ? "#FF4A4A" : "#E10606";

            const stressLevelDescription = {
                "คะแนน 0-6": `ผลการประเมินของคุณอยู่ในระดับที่ไม่มีภาวะซึมเศร้า ซึ่งเป็นเรื่องที่น่ายินดีมากค่ะ คุณสามารถดูแลสุขภาพจิตใจของคุณได้เป็นอย่างดี`,
                "คะแนน 7-12": `ผลการประเมินของคุณบ่งชี้ว่าคุณมีภาวะซึมเศร้าระดับน้อย ซึ่งเป็นสัญญาณเตือนให้คุณหันมาดูแลสุขภาพจิตใจของตัวเองมากขึ้น ลองหากิจกรรมที่ช่วยผ่อนคลายความเครียด เช่น การออกกำลังกาย การฟังเพลง หรือการพูดคุยกับคนที่คุณไว้ใจ หากคุณรู้สึกว่าความเครียดเริ่มส่งผลกระทบต่อการใช้ชีวิตประจำวัน ลองปรึกษาผู้เชี่ยวชาญเพื่อขอคำแนะนำเพิ่มเติมนะคะ`,
                "คะแนน 13-18": `ผลการประเมินของคุณบ่งชี้ว่าคุณมีภาวะซึมเศร้าระดับปานกลาง ซึ่งอาจส่งผลต่อการใช้ชีวิตประจำวันของคุณได้ ดิฉันแนะนำให้คุณปรึกษาผู้เชี่ยวชาญด้านสุขภาพจิต เพื่อรับการวินิจฉัยและการรักษาที่เหมาะสม การขอความช่วยเหลือไม่ใช่เรื่องน่าอาย และเป็นสัญญาณของความเข้มแข็งนะคะ`,
                "คะแนน ≥19": `ผลการประเมินของคุณบ่งชี้ว่าคุณมีภาวะซึมเศร้าระดับรุนแรง ซึ่งจำเป็นต้องได้รับการดูแลจากผู้เชี่ยวชาญโดยเร็วที่สุด ดิฉันแนะนำให้คุณปรึกษาจิตแพทย์หรือผู้ให้คำปรึกษา เพื่อรับการวินิจฉัยและการรักษาที่เหมาะสม การขอความช่วยเหลือเป็นสิ่งสำคัญอย่างยิ่งในการดูแลสุขภาพจิตใจของคุณ`
            }[level];

            const flexMessage = {
                type: "flex",
                altText: "ผลคะแนนความเครียดของคุณ",
                contents: {
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "margin": "md",
                                "contents": [
                                    {
                                        "type": "box",
                                        "layout": "vertical",
                                        "contents": [
                                            {
                                                "type": "image",
                                                "url": profilePictureUrl,
                                                "size": "full",
                                                "aspectMode": "cover",
                                                "action": {
                                                    "type": "uri",
                                                    "uri": "https://line.me/R/oaMessage/@466kmqzg/?การประเมินตนเอง"
                                                },
                                                "aspectRatio": "1:1"
                                            }
                                        ],
                                        "justifyContent": "center",
                                        "cornerRadius": "100px",
                                        "width": "50px",
                                        "height": "50px"
                                    },
                                    {
                                        "type": "text",
                                        "text": "ผลคะแนนของคุณ",
                                        "weight": "bold",
                                        "size": "lg",
                                        "align": "center"
                                    }
                                ],
                                "position": "relative",
                                "justifyContent": "center",
                                "alignItems": "center",
                                "backgroundColor": "#FFFACD",
                                "paddingAll": "5px",
                                "cornerRadius": "10px",
                                "borderWidth": "2px",
                                "borderColor": "#ffffff"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "margin": "md",
                                "contents": [
                                    {
                                        "type": "box",
                                        "layout": "horizontal",
                                        "contents": [
                                            { "type": "text", "text": `${totalScore}`, "weight": "bold", "size": "5xl", "align": "center" },
                                            {
                                                "type": "box",
                                                "layout": "vertical",
                                                "contents": [
                                                    { "type": "text", "text": "คะแนน", "weight": "bold", "size": "xl" }
                                                ],
                                                "justifyContent": "center",
                                                "width": "80px"
                                            }
                                        ],
                                        "width": "180px"
                                    },
                                    { "type": "text", "text": `ระดับความเครียด: ${level}`, "weight": "bold", "size": "lg", "align": "center" }
                                ],
                                "backgroundColor": vbackgroundColor,
                                "paddingAll": "5px",
                                "cornerRadius": "10px",
                                "alignItems": "center",
                                "borderWidth": "2px",
                                "borderColor": "#ffffff"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "margin": "md",
                                "contents": [
                                    { "type": "text", "text": stressLevelDescription, "size": "sm", "wrap": true }
                                ],
                                "backgroundColor": "#FADADD",
                                "paddingAll": "5px",
                                "cornerRadius": "10px",
                                "borderWidth": "2px",
                                "borderColor": "#ffffff"
                            }
                        ],
                        "backgroundColor": "#90EE90",
                        "paddingAll": "10px"
                    },
                    "size": "kilo"
                }
            };


            //await liff.sendMessages([flexMessage]);
            await liff.sendMessages([{ type: "text", text: "ทดสอบการส่งข้อความ" }]);
        }

        // เริ่มต้น
        initializeLiff();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f4f6f8;
            color: #555;
            flex-direction: column;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #message {
            text-align: center;
            max-width: 80%;
        }

        .config-error {
            color: #d9534f;
            background: #f9f2f4;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #d9534f;
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T1S5VW5N9W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-T1S5VW5N9W');
    </script>
</head>

<body>

    <div class="loader" id="loader"></div>
    <div id="message">Processing...</div>

    <script>
        // ==========================================
        // CONFIGURATION SECTION - EDIT THIS!
        // ==========================================
        const CONFIG = {
            // Paste your Google Apps Script Web App URL here
            // Example: "https://script.google.com/macros/s/AKfycby.../exec"
            WEB_APP_URL: "https://script.google.com/macros/s/AKfycbygcvjOD3FDGHUGQAg0uHSmpS7miE39u3kSdLL_Pz_CiRv5EsAmZi6bP5w5E1MzbNVz/exec"
        };
        // ==========================================

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const msgEl = document.getElementById('message');
            const loaderEl = document.getElementById('loader');

            if (!CONFIG.WEB_APP_URL) {
                loaderEl.style.display = 'none';
                msgEl.innerHTML = `<div class='config-error'>
                    <strong>System Not Configured</strong><br>
                    Please edit <code>index.html</code> and set the <code>WEB_APP_URL</code> variable.
                </div>`;
                return;
            }

            if (!id) {
                // If no ID is present, and we are not on admin page, maybe show a 404 or admin link
                // For now, just say Link Not Found
                loaderEl.style.display = 'none';
                msgEl.textContent = "Link ID not found.";
                return;
            }

            // Gather Metadata
            const meta = {
                userAgent: navigator.userAgent,
                screen: `${window.screen.width}x${window.screen.height}`,
                referrer: document.referrer,
                language: navigator.language,
                time: new Date().toISOString()
            };

            try {
                // Determine connector (params separator) for GAS URL
                // usually GAS URLs end in /exec. we append ?action=log...
                const fetchUrl = `${CONFIG.WEB_APP_URL}?action=log&id=${id}&meta=${encodeURIComponent(JSON.stringify(meta))}`;

                const response = await fetch(fetchUrl);
                const data = await response.json();

                if (data.status === "success" && data.targetUrl) {
                    msgEl.textContent = "Redirecting...";
                    window.location.href = data.targetUrl;
                } else {
                    throw new Error(data.message || "Unknown error");
                }
            } catch (err) {
                loaderEl.style.display = 'none';
                console.error(err);
                msgEl.textContent = "Error: " + err.message;
            }
        }

        init();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMMA Call System</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Modern Glassmorphism & Animations */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Prompt', sans-serif; /* Assumed Thai font preference */
        }
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap');
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .btn-animate {
            transition: all 0.2s ease-in-out;
        }
        .btn-animate:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-600 animate-pulse">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Main Content -->
    <div id="app" class="glass-panel w-full max-w-md p-8 shadow-2xl hidden">
        <div class="text-center mb-8">
            <div id="profileImage" class="w-24 h-24 mx-auto bg-gray-300 rounded-full mb-4 bg-cover bg-center border-4 border-white shadow-md"></div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">สวัสดี, <span id="displayName">...</span></h1>
            <p class="text-gray-500 text-sm">เลือกบริการที่คุณต้องการ</p>
        </div>

        <div class="space-y-4">
            <!-- Button 1: Consult -->
            <button onclick="handleAction('consult')" class="btn-animate w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-6 rounded-xl shadow-lg hover:shadow-xl flex items-center justify-center space-x-3 group">
                <svg class="w-8 h-8 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                <div class="text-left">
                    <div class="text-xl font-bold">ขอปรึกษาคุณหมอ</div>
                    <div class="text-xs opacity-90">Consult Doctor</div>
                </div>
            </button>

            <!-- Button 2: Help -->
            <button onclick="handleAction('help')" class="btn-animate w-full bg-gradient-to-r from-red-500 to-pink-500 text-white p-6 rounded-xl shadow-lg hover:shadow-xl flex items-center justify-center space-x-3 group">
                <svg class="w-8 h-8 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div class="text-left">
                    <div class="text-xl font-bold">ช่วยด้วย</div>
                    <div class="text-xs opacity-90">Emergency Help</div>
                </div>
            </button>
        </div>
        
        <div id="statusMessage" class="mt-6 text-center text-sm text-gray-500 hidden"></div>
    </div>

    <script>
        const LIFF_ID = '2006670422-QiRXwT4r';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSIOyXfb5MaLD5MmQPRxyRjDqKoumVnjJbaX20-3ApiypMnHppJS9ghOKTMGS3s7BuBg/exec';

        // --- Core Logic ---

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                document.getElementById('displayName').innerText = profile.displayName;
                if(profile.pictureUrl) {
                    document.getElementById('profileImage').style.backgroundImage = `url(${profile.pictureUrl})`;
                }
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');

            } catch (err) {
                console.error('LIFF Init Error:', err);
                alert('เกิดข้อผิดพลาดในการโหลด LIFF: ' + err.message);
            }
        }

        async function handleAction(actionType) {
            // 1. Show processing state
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerText = 'กำลังระบุพิกัดและส่งข้อมูล...';
            statusDiv.classList.remove('hidden', 'text-green-600', 'text-red-500');
            
            try {
                // 2. Get Geolocation
                const location = await getGeolocation();
                
                // 3. Get User Profile
                const profile = await liff.getProfile();
                const os = liff.getOS();

                // 4. Prepare Payload
                const payload = {
                    userId: profile.userId,
                    name: profile.displayName,
                    pictureUrl: profile.pictureUrl, // Sent just in case
                    os: os,
                    latitude: location.coords.latitude,
                    longitude: location.coords.longitude,
                    action: actionType // "consult" or "help"
                };

                // 5. Send to Server (Google Apps Script)
                // Use no-cors mode because we just want to trigger the POST, 
                // but reading response might be tricky with CORS. 
                // Standard GAS `ContentService.createTextOutput` with JSONP or CORS headers needed on server.
                // Assuming standard `fetch` for now.
                
                // Note: fetch with POST to GAS usually requires handling CORS redirects.
                // Using 'no-cors' prevents reading response text but ensures request is sent.
                // If you need to read response, GAS must return JSON with correct headers.
                
                statusDiv.innerText = 'กำลังส่งข้อมูลไปยังระบบ...';

                // Try standard CORS first (safest if Server handles it)
                // Since GAS is tricky, we'll try a specialized fetch approach or just standard.
                // We will send stringified body.
                
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for simple GAS triggers from browser
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });

                // Since 'no-cors' doesn't return status, we assume success if no error thrown.
                statusDiv.innerText = 'ส่งข้อมูลสำเร็จ! เจ้าหน้าที่ได้รับข้อมูลแล้ว';
                statusDiv.classList.add('text-green-600');
                
                // Optional: Close window after delay
                setTimeout(() => {
                    liff.closeWindow();
                }, 3000);

            } catch (err) {
                console.error('Action Error:', err);
                statusDiv.innerText = 'เกิดข้อผิดพลาด: ' + err.message;
                statusDiv.classList.add('text-red-500');
            }
        }

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Browser does not support Geolocation'));
                } else {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                }
            });
        }

        // Start
        main();
    </script>
</body>
</html>

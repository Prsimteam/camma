<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMMA Call System</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Modern Glassmorphism & Animations */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Prompt', sans-serif; /* Assumed Thai font preference */
        }
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap');
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .btn-animate {
            transition: all 0.2s ease-in-out;
        }
        .btn-animate:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-600 animate-pulse">กำลังดึงข้อมูล...</p>
    </div>

    <!-- Main Content -->
    <div id="app" class="glass-panel w-full max-w-md p-8 shadow-2xl hidden">
        <div class="text-center mb-8">
            <div id="profileImage" class="w-24 h-24 mx-auto bg-gray-300 rounded-full mb-4 bg-cover bg-center border-4 border-white shadow-md"></div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">สวัสดี, <span id="displayName">...</span></h1>
            <p class="text-gray-500 text-sm">เลือกสิ่งที่ต้องการเพื่อให้ระบบช่วยได้เร็ว</p>
        </div>

        <div class="space-y-4">
            <!-- Button 1: Consult -->
            <button id="btn-consult" onclick="handleAction('consult')" class="btn-animate w-full bg-gradient-to-r from-sky-600 to-teal-500 text-white py-7 px-8 rounded-2xl shadow-2xl hover:shadow-3xl text-left flex items-center space-x-4 group">
                <svg class="w-8 h-8 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                <div class="text-left">
                    <div class="text-xl font-bold">ปรึกษาแพทย์/เจ้าหน้าที่</div>
                    <div class="text-xs opacity-90">Consult Doctor</div>
                </div>
            </button>

            <!-- Button 2: Help -->
            <button id="btn-help" onclick="handleAction('help')" class="btn-animate w-full bg-gradient-to-r from-red-600 to-orange-500 text-white py-7 px-8 rounded-2xl shadow-2xl hover:shadow-3xl text-left flex items-center space-x-4 group">
                <svg class="w-8 h-8 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div class="text-left">
                    <div class="text-xl font-bold">ขอความช่วยเหลือฉุกเฉิน</div>
                    <div class="text-xs opacity-90">Emergency Help</div>
                </div>
            </button>
        </div>
        
        <p class="text-center text-sm text-gray-700 mt-3">
          สีฟ้า = ปรึกษาได้ รอคิวได้ · สีแดง = ฉุกเฉิน ต้องรีบ
        </p>
        
        <div id="statusMessage" class="mt-6 text-center text-sm text-gray-500 hidden"></div>
    </div>

    <script>
          const LIFF_ID = '2006670422-QiRXwT4r';
          const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSIOyXfb5MaLD5MmQPRxyRjDqKoumVnjJbaX20-3ApiypMnHppJS9ghOKTMGS3s7BuBg/exec';
  
          // --- Core Logic ---
  
          async function main() {
              try {
                  await liff.init({ liffId: LIFF_ID });
                  if (!liff.isLoggedIn()) {
                      liff.login();
                      return;
                  }
                  
                  const profile = await liff.getProfile();
                  document.getElementById('displayName').innerText = profile.displayName;
                  if(profile.pictureUrl) {
                      document.getElementById('profileImage').style.backgroundImage = `url(${profile.pictureUrl})`;
                  }
                  
                  document.getElementById('loading').classList.add('hidden');
                  document.getElementById('app').classList.remove('hidden');
  
              } catch (err) {
                  console.error('LIFF Init Error:', err);
                  alert('เกิดข้อผิดพลาด LIFF: ' + err.message);
              }
          }
  
          const userFlex = (name, actionLabel) => ({
            type: "flex",
            altText: `รับเรื่อง: ${actionLabel}`,
            contents: {
              type: "bubble",
              body: {
                type: "box",
                layout: "vertical",
                spacing: "md",
                contents: [
                  { type: "text", text: "รับเรื่องแล้ว", weight: "bold", size: "xl", color: "#2563eb" },
                  { type: "text", text: `${actionLabel}`, size: "lg", weight: "bold" },
                  { type: "text", text: `คุณ ${name} ระบบบันทึกและแจ้งทีมแล้ว`, wrap: true, color: "#4b5563", size: "sm" }
                ]
              }
            }
          });
  
          async function handleAction(actionType) {
              const consultBtn = document.getElementById('btn-consult');
              const helpBtn = document.getElementById('btn-help');
              consultBtn.disabled = true;
              helpBtn.disabled = true;
              consultBtn.classList.add('opacity-70');
              helpBtn.classList.add('opacity-70');

              const statusDiv = document.getElementById('statusMessage');
              statusDiv.innerText = actionType === 'help'
                ? 'กำลังส่งคำขอฉุกเฉิน...'
                : 'กำลังส่งคำขอปรึกษา...';
              statusDiv.classList.remove('hidden', 'text-green-600', 'text-red-500');
              
              try {
                  const [location, profile] = await Promise.all([getGeolocation(), liff.getProfile()]);
                  const os = liff.getOS();

                  const payload = {
                      userId: profile.userId,
                      name: profile.displayName,
                      pictureUrl: profile.pictureUrl,
                      os: os,
                      latitude: location.coords.latitude,
                      longitude: location.coords.longitude,
                      action: actionType
                  };
  
                  fetch(GOOGLE_SCRIPT_URL, {
                      method: 'POST',
                      mode: 'no-cors',
                      cache: 'no-cache',
                      headers: { 'Content-Type': 'application/json' },
                      redirect: 'follow',
                      body: JSON.stringify(payload)
                  });
  
                  const label = actionType === 'help' ? 'ขอความช่วยเหลือด่วน' : 'ปรึกษาแพทย์';
                  await liff.sendMessages([ userFlex(profile.displayName, label) ]);

                  statusDiv.innerText = 'ส่งสำเร็จแล้ว ระบบจะปิดอัตโนมัติ';
                  statusDiv.classList.add('text-green-600');
                  setTimeout(() => {
                      liff.closeWindow();
                  }, 2500);

              } catch (err) {
                  console.error('Action Error:', err);
                  statusDiv.innerText = 'ส่งไม่สำเร็จ: ' + err.message;
                  statusDiv.classList.add('text-red-500');
              }
              finally {
                  consultBtn.disabled = false;
                  helpBtn.disabled = false;
                  consultBtn.classList.remove('opacity-70');
                  helpBtn.classList.remove('opacity-70');
              }
          }

          function getGeolocation() {
              return new Promise((resolve, reject) => {
                  if (!navigator.geolocation) {
                      reject(new Error('Browser does not support Geolocation'));
                  } else {
                      navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 8000,
                        maximumAge: 10000
                      });
                  }
              });
          }
  
          // Start
          main();
      </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>แบบประเมินความเครียด (ST-5)</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <!-- Line LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.16.0/sdk.js"></script>
  <style>
    body {
      padding: 20px;
    }
    .question {
      margin-bottom: 20px;
    }
    button {
      width: 100%;
      padding: 10px;
      font-size: 18px;
    }


  </style>
</head>
<body>
  <div id="app" class="container">
    <h1 class="text-center my-4">แบบประเมินความเครียด (ST-5)</h1>
    <p class="text-center lead">
      ใน 2 สัปดาห์ที่ผ่านมา รวมวันนี้ ท่านรู้สึกอย่างไร?...<br>
      โดยเลือกคำตอบที่ตรงกับความรู้สึกของท่านมากที่สุด
    </p>
    <form @submit.prevent="submitForm" v-if="!submitted">
      <div v-for="(question, index) in questions" :key="index" class="question card p-3 mb-3 shadow-sm">
        <p class="fw-bold">{{ question.text }}</p>
        <div class="form-check" v-for="option in options" :key="option.value">
          <input
            class="form-check-input"
            type="radio"
            :name="'q' + index"
            :value="option.value"
            v-model="answers[index]"
          />
          <label class="form-check-label">{{ option.label }}</label>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">ส่งคำตอบ</button>
    </form>
    <div v-if="submitted" class="result text-center mt-5">
      <h2 class="text-success">ขอบคุณที่ทำแบบสอบถาม!</h2>
      <p class="lead">ผลคะแนนของคุณได้ถูกส่งไปยังแชทของคุณแล้ว</p>
    </div>
  </div>
  <script>
    // Initialize LIFF
    async function initializeLiff() {
      await liff.init({ liffId: "2006670422-3b8vmOqK" });
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        app.userId = profile.userId; // เก็บ User ID ไว้ใน Vue instance
        app.userPictureUrl = profile.pictureUrl || "https://lh3.googleusercontent.com/d/1U4hzLd-IRerepRj8WPnupuCOMypasYtm"; // รูปโปรไฟล์หรือรูปสำรอง
      }
    }

    const app = new Vue({
      el: '#app',
      data: {
        userId: null, // จะถูกกำหนดค่าจาก Line LIFF
        userPictureUrl: null, // URL รูปโปรไฟล์ของผู้ใช้งาน
        questions: [
          { text: "มีปัญหาการนอน นอนไม่หลับหรือนอนมาก" },
          { text: "มีสมาธิน้อยลง" },
          { text: "หงุดหงิด/กระวนกระวาย/ว้าวุ่นใจ" },
          { text: "รู้สึกเบื่อ เซ็ง" },
          { text: "ไม่อยากพบปะผู้คน" },
        ],
        options: [
          { label: "แทบไม่มี", value: 0 },
          { label: "เป็นบางครั้ง", value: 1 },
          { label: "บ่อยครั้ง", value: 2 },
          { label: "เป็นประจำ", value: 3 },
        ],
        answers: [],
        submitted: false,
      },
      computed: {
        totalScore() {
          return this.answers.reduce((sum, answer) => sum + (parseInt(answer) || 0), 0);
        },
      },
      methods: {
        async submitForm() {
          const data = {
            userId: this.userId,
            question1: this.answers[0],
            question2: this.answers[1],
            question3: this.answers[2],
            question4: this.answers[3],
            question5: this.answers[4],
          };

          try {
            // ส่งข้อมูลไปยัง Google Apps Script
            //await this.sendDataToGoogleAppsScript(data);

            // ส่ง Flex Message กลับไปยังผู้ใช้งาน
            await this.sendFlexMessage();

            this.submitted = true;
          } catch (error) {
            console.error(error);
            alert("ไม่สามารถเชื่อมต่อได้");
          }
        },
        async sendDataToGoogleAppsScript(data) {
          const response = await fetch("https://script.google.com/macros/s/AKfycbwDvpE58nUXpT8WWHAm-s9kDqsH8B4gTAHhb0Ic5aQE3zPyCqqVrPXapXY_jq9wPSamHQ/exec", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        },
async sendFlexMessage() {
  const totalScore = this.totalScore;
  const level = totalScore <= 5 ? "ต่ำ" : totalScore <= 10 ? "ปานกลาง" : "สูง";

  // กำหนดค่า backgroundColor และ text โดยใช้ if
  let vbackgroundColor;
  if (level === "ต่ำ") {
    vbackgroundColor = "#008000"; // สีเขียว
  } else if (level === "ปานกลาง") {
    vbackgroundColor = "#FFA500"; // สีส้ม
  } else if (level === "สูง") {
    vbackgroundColor = "#ff0000"; // สีแดง
  }

  const stressLevelText = `มีความเครียด${level}`;

  const flexMessage = {
    type: "flex",
    altText: "ผลคะแนนความเครียดของคุณ",
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "image",
                    url: this.userPictureUrl, // รูปโปรไฟล์ของผู้ใช้งาน
                    aspectMode: "cover",
                    size: "full",
                    align: "center",
                    cornerRadius: "100px",
                    width: "200px",
                    height: "200px",
                  },
                ],
              },
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "box",
                    layout: "baseline",
                    contents: [
                      {
                        type: "text",
                        text: "ได้คะแนน",
                        size: "xl",
                        weight: "bold",
                        align: "center",
                      },
                    ],
                    spacing: "sm",
                    margin: "md",
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    contents: [
                      {
                        type: "text",
                        text: `${totalScore}`,
                        size: "5xl",
                        color: "#111111",
                        align: "center",
                      },
                      {
                        type: "text",
                        text: "คะแนน",
                        size: "lg",
                        color: "#444444",
                        align: "center",
                      },
                      {
                        type: "text",
                        text: `${level}`,
                        size: "xl",
                        align: "center",
                        weight: "bold",
                      },
                      {
                        type: "separator",
                        margin: "20px",
                      },
                    ],
                    spacing: "sm",
                    margin: "md",
                    backgroundColor: "#ff0000",
                    cornerRadius: "xxl",
                  },
                ],
                paddingAll: "sm",
                width: "250px",
              },
            ],
            spacing: "xl",
            paddingAll: "20px",
            alignItems: "center",
          },
        ],
        paddingAll: "0px",
        backgroundColor: "#f6f6f6",
      },
    },
  };

  try {
    await liff.sendMessages([flexMessage]);
    liff.closeWindow();
  } catch (error) {
    console.error("เกิดข้อผิดพลาดในการส่งข้อความ:", error);
    alert("ไม่สามารถส่งข้อความได้");
  }
},
      },
    });

    // Initialize LIFF on page load
    initializeLiff();
  </script>
  <!-- Bootstrap JS (Optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

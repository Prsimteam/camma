<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบประเมินความเครียด (ST-5)</title>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="radio"]:checked + span {
              background-color: #dbeafe;
              color: #1e40af;
              font-weight: bold;
              font-size: larger;
              padding: 5px 24px;
              border-radius: 20px;
        }

</style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 mt-10">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">แบบประเมินความเครียด (ST-5)</h1>

        <p class="text-gray-600 mb-6">
            ใน 2 สัปดาห์ที่ผ่านมา รวมวันนี้ ท่านรู้สึกอย่างไร?...<br>
            โดยเลือกคำตอบที่ตรงกับความรู้สึกของท่านมากที่สุด
        </p>

        <!-- คำถามที่ 1 -->
        <div class="mb-6">
            <p class="font-medium text-gray-800 mb-3">1. มีปัญหาการนอน นอนไม่หลับหรือนอนมาก?</p>
            <div class="space-y-2">
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                    <input type="radio" name="question1" value="0" class="hidden">
                    <span class="ml-3 text-gray-700">แทบไม่มี</span>
                </label>
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                    <input type="radio" name="question1" value="1" class="hidden">
                    <span class="ml-3 text-gray-700">เป็นบางครั้ง</span>
                </label>
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                    <input type="radio" name="question1" value="2" class="hidden">
                    <span class="ml-3 text-gray-700">ค่อนข้างบ่อย</span>
                </label>
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                    <input type="radio" name="question1" value="3" class="hidden">
                    <span class="ml-3 text-gray-700">เป็นประจำ</span>
                </label>
            </div>
        </div>
        <!-- คำถามที่ 2 -->
        <div class="mb-6">
          <p class="font-medium text-gray-800 mb-3">2. มีสมาธิน้อยลง?</p>
          <div class="space-y-2">
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question2" value="0" class="hidden">
                  <span class="ml-3 text-gray-700">แทบไม่มี</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question2" value="1" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นบางครั้ง</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question2" value="2" class="hidden">
                  <span class="ml-3 text-gray-700">ค่อนข้างบ่อย</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question2" value="3" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นประจำ</span>
              </label>
          </div>
      </div>
        <!-- คำถามที่ 3 -->
        <div class="mb-6">
          <p class="font-medium text-gray-800 mb-3">3. หงุดหงิด/กระวนกระวาย/ว้าวุ่นใจ?</p>
          <div class="space-y-2">
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question3" value="0" class="hidden">
                  <span class="ml-3 text-gray-700">แทบไม่มี</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question3" value="1" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นบางครั้ง</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question3" value="2" class="hidden">
                  <span class="ml-3 text-gray-700">ค่อนข้างบ่อย</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question3" value="3" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นประจำ</span>
              </label>
          </div>
      </div>
        <!-- คำถามที่ 4 -->
        <div class="mb-6">
          <p class="font-medium text-gray-800 mb-3">4. รู้สึกเบื่อ เซ็ง?</p>
          <div class="space-y-2">
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question4" value="0" class="hidden">
                  <span class="ml-3 text-gray-700">แทบไม่มี</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question4" value="1" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นบางครั้ง</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question4" value="2" class="hidden">
                  <span class="ml-3 text-gray-700">ค่อนข้างบ่อย</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question4" value="3" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นประจำ</span>
              </label>
          </div>
      </div>
        <!-- คำถามที่ 5 -->
        <div class="mb-6">
          <p class="font-medium text-gray-800 mb-3">5. ไม่อยากพบปะผู้คน?</p>
          <div class="space-y-2">
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question5" value="0" class="hidden">
                  <span class="ml-3 text-gray-700">แทบไม่มี</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question5" value="1" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นบางครั้ง</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question5" value="2" class="hidden">
                  <span class="ml-3 text-gray-700">ค่อนข้างบ่อย</span>
              </label>
              <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition">
                  <input type="radio" name="question5" value="3" class="hidden">
                  <span class="ml-3 text-gray-700">เป็นประจำ</span>
              </label>
          </div>
      </div>


        <!-- เพิ่มคำถามที่เหลือ (3-5) ตามโครงสร้างเดียวกัน -->

        <!-- ปุ่มส่งคำตอบ -->
        <button id="submitButton" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
            ส่งคำตอบ
        </button>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        // Initialize LIFF
        async function initializeLiff() {
            try {
                console.log('Starting LIFF initialization...');
                await liff.init({ liffId: '2006670422-3b8vmOqK' });
                console.log('LIFF initialized successfully');

                // ตรวจสอบสถานะการล็อกอิน
                if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        const profile = await liff.getProfile();
                        profilePictureUrl = profile.pictureUrl || 'https://via.placeholder.com/200';
                       /* if (!liff.isInClient()) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'กรุณาเปิดใน LINE',
                                text: 'โปรดเปิดลิงก์นี้ผ่านแอปพลิเคชัน LINE'
                            });
                        }
                        */
                    }

            } catch (error) {
                console.error('Error initializing LIFF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถเชื่อมต่อ LINE ได้',
                    text: error.message || 'กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่'
                });
            }
        }

        // ส่งคำตอบและข้อความผ่าน LINE
                document.getElementById('submitButton').addEventListener('click', async () => {
            const answers = [
                document.querySelector('input[name="question1"]:checked'),
                document.querySelector('input[name="question2"]:checked'),
                document.querySelector('input[name="question3"]:checked'),
                document.querySelector('input[name="question4"]:checked'),
                document.querySelector('input[name="question5"]:checked')
            ];
        
            if (answers.some(answer => !answer)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาตอบคำถามทั้งหมด',
                    text: 'คุณยังไม่ได้ตอบคำถามบางข้อ'
                });
                return;
            }
        
            const [q1, q2, q3, q4, q5] = answers.map(answer => parseInt(answer.value));
            const totalScore = q1 + q2 + q3 + q4 + q5;
        
            sendFlexMessage(totalScore);
        
            const data = {
                userId: liff.getDecodedIDToken()?.sub || 'unknown',
                question1: q1,
                question2: q2,
                question3: q3,
                question4: q4,
                question5: q5,
                totalScore: totalScore,
                timestamp: new Date().toISOString()
            };
        
            const scriptURL = 'https://script.google.com/macros/s/AKfycbwDvpE58nUXpT8WWHAm-s9kDqsH8B4gTAHhb0Ic5aQE3zPyCqqVrPXapXY_jq9wPSamHQ/exec';
                            // https://script.google.com/macros/s/AKfycbwDvpE58nUXpT8WWHAm-s9kDqsH8B4gTAHhb0Ic5aQE3zPyCqqVrPXapXY_jq9wPSamHQ/exec
            try {
                console.log('Sending request to:', scriptURL);
                console.log('Data:', JSON.stringify(data));
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('Response status:', response.status);
                console.log('Response text:', await response.text());
        
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
        
                Swal.fire({
                    icon: 'success',
                    title: 'ส่งคำตอบสำเร็จ!',
                    text: 'ผลคะแนนของคุณได้ถูกส่งไปยังแชทแล้ว'
                }).then(() => liff.closeWindow());
            } catch (error) {
                console.error('Submission Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้: ${error.message}'
                });
            }
        });

        // ฟังก์ชันสร้างและส่ง Flex Message
        async function sendFlexMessage(totalScore) {
            const level =
                totalScore <= 4
                    ? "ต่ำ"
                    : totalScore <= 7
                    ? "ปานกลาง"
                    : totalScore <= 9
                    ? "สูง"
                    : "สูงมาก";

            let vbackgroundColor;
            if (level === "ต่ำ") {
                vbackgroundColor = "#45fa36"; // สีเขียว (เครียดน้อย)
            } else if (level === "ปานกลาง") {
                vbackgroundColor = "#FFA500"; // สีส้ม (เครียดปานกลาง)
            } else if (level === "สูง") {
                vbackgroundColor = "#ff0000"; // สีแดง (เครียดมาก)
            } else if (level === "สูงมาก") {
                vbackgroundColor = "#8B0000"; // สีแดงเข้ม (เครียดมากที่สุด)
            }

            const stressLevelDescription = {
                "ต่ำ": `ระดับคะแนน 0 - 4 รู้สึกเครียดเล็กน้อย\nท่านมีความเครียดอยู่ในระดับน้อยและหายไปได้ในระยะเวลาสั้นๆ เป็นความเครียดที่เกิดขึ้นได้ในชีวิตประจำวัน และสามารถปรับตัวกับสถานการณ์ต่างๆ ได้อย่างเหมาะสม ความเครียดในระดับนี้ถือว่ามีประโยชน์ในการดำเนินชีวิตประจำวัน เป็นแรงจูงใจที่นำไปสู่ความสำเร็จในชีวิตได้`,
                "ปานกลาง": `ระดับคะแนน 5 - 7 รู้สึกเครียดปานกลาง\nท่านมีความเครียดในระดับปานกลาง เกิดขึ้นได้ในชีวิตประจำวัน เนื่องจากมีสิ่งคุกคามหรือเหตุการณ์ที่ทำให้เครียด อาจรู้สึกวิตกกังวลหรือกลัว ถือว่าอยู่ในเกณฑ์ปกติ ความเครียดระดับนี้ไม่ก่อให้เกิดอันตรายหรือเป็นผลเสียต่อการดำเนินชีวิต ท่านสามารถผ่อนคลายความเครียดด้วยการออกกำลังกาย เล่นกีฬา ทำสิ่งที่สนุกสนานเพลิดเพลิน เช่น อ่านหนังสือ ฟังเพลง ทำงานอดิเรก หรือพูดคุยระบายความไม่สบายใจกับผู้ที่ไว้วางใจ`,
                "สูง": `ระดับคะแนน 8 - 9 รู้สึกเครียดมาก\nท่านมีความเครียดในระดับมาก เป็นระดับที่ท่านได้รับความเดือดร้อนจากสิ่งต่างๆ หรือเหตุการณ์รอบตัว ทำให้วิตกกังวล กลัว รู้สึกขัดแย้งหรืออยู่ในสถานการณ์ที่แก้ไข / จัดการปัญหานั้นไม่ได้ ปรับความรู้สึกด้วยความลำบากจะส่งผลต่อการใช้ชีวิตประจำวัน และการเจ็บป่วย เช่น ความดันโลหิตสูง เป็นแผลในกระเพาะอาหาร ฯลฯ สิ่งที่ท่านต้องรีบทำเมื่อมีความเครียดในระดับนี้คือคลายเครียดด้วยวิธีที่ทำได้ง่ายแต่ได้ผลดีคือ การฝึกหายใจคลายเครียด พูดคุยระบายความเครียดกับผู้ที่ไว้วางใจ หาสาเหตุหรือปัญหาที่ทำให้เกิดความเครียดและหาวิธีแก้ไข หากท่านไม่สามารถจัดการคลายเครียดด้วยตนเอง ควรปรึกษากับผู้ให้การปรึกษาในหน่วยงานต่างๆ`,
                "สูงมาก": `ระดับคะแนน 10 - 15 รู้สึกเครียดมากที่สุด\nท่านมีความเครียดในระดับมากที่สุด เป็นความเครียดระดับสูงที่เกิดขึ้นต่อเนื่องหรือท่านกำลังเผชิญกับวิกฤตของชีวิต เช่น เจ็บป่วยรุนแรง / เรื้อรัง มีความพิการ สูญเสียคนรัก ทรัพย์สิน หรือสิ่งที่รัก ความเครียดระดับนี้ส่งผลทำให้เจ็บป่วยทางกายและสุขภาพจิต ชีวิตไม่มีความสุข ความคิดฟุ้งซ่าน การตัดสินใจไม่ดี ยับยั้งอารมณ์ไม่ได้ ความเครียดระดับนี้ถ้าปล่อยไว้จะเกิดผลเสียทั้งต่อตนเองและคนใกล้ชิด ควรได้รับการช่วยเหลือจากผู้ให้การปรึกษาอย่างรวดเร็ว เช่น ทางโทรศัพท์ หรือผู้ให้การปรึกษาในหน่วยงานต่างๆ`,
            }[level];

            const flexMessage = {
                type: "flex",
                altText: "ผลคะแนนความเครียดของคุณ",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            {
                                type: "box",
                                layout: "vertical",
                                contents: [
                                    {
                                        type: "box",
                                        layout: "vertical",
                                        contents: [
                                            {
                                                type: "image",
                                                url: profilePictureUrl,
                                                aspectMode: "cover",
                                                size: "full",
                                                align: "center",
                                            },
                                        ],
                                        cornerRadius: "100px",
                                        width: "200px",
                                        height: "200px",
                                    },
                                    {
                                        type: "box",
                                        layout: "vertical",
                                        contents: [
                                            {
                                                type: "box",
                                                layout: "baseline",
                                                contents: [
                                                    {
                                                        type: "text",
                                                        text: "ผลคะแนนความเครียด",
                                                        size: "xl",
                                                        weight: "bold",
                                                        align: "center",
                                                    },
                                                ],
                                                spacing: "sm",
                                                margin: "md",
                                            },
                                            {
                                                type: "box",
                                                layout: "vertical",
                                                contents: [
                                                    {
                                                        type: "text",
                                                        text: `${totalScore}`,
                                                        size: "5xl",
                                                        color: "#111111",
                                                        align: "center",
                                                    },
                                                    {
                                                        type: "text",
                                                        text: "คะแนน",
                                                        size: "lg",
                                                        color: "#444444",
                                                        align: "center",
                                                    },
                                                    {
                                                        type: "text",
                                                        text: `ระดับความเครียด: ${level}`,
                                                        size: "sm",
                                                        align: "center",
                                                        weight: "bold",
                                                    },
                                                    {
                                                        type: "separator",
                                                        margin: "20px",
                                                    },
                                                ],
                                                spacing: "sm",
                                                margin: "md",
                                                backgroundColor: vbackgroundColor,
                                                cornerRadius: "xxl",
                                            },
                                            {
                                                type: "box",
                                                layout: "vertical",
                                                contents: [
                                                    {
                                                        type: "text",
                                                        text: stressLevelDescription,
                                                        wrap: true,
                                                        size: "md",
                                                    },
                                                ],
                                                paddingAll: "10px",
                                                backgroundColor: "#afffff",
                                                cornerRadius: "20px",
                                                margin: "lg",
                                            },
                                        ],
                                        paddingAll: "sm",
                                        width: "250px",
                                    },
                                ],
                                spacing: "xl",
                                paddingAll: "20px",
                                alignItems: "center",
                            },
                        ],
                        paddingAll: "0px",
                        backgroundColor: "#f6f6f6",
                    },
                },
            };

            try {
                await liff.sendMessages([flexMessage]);
            } catch (error) {
                console.error('Flex Message Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถส่งผลลัพธ์',
                    text: 'กรุณาลองใหม่',
                    showCancelButton: true,
                    confirmButtonText: 'ลองใหม่',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) sendFlexMessage(totalScore);
                });
            }
        }

        // เริ่มต้น LIFF
        initializeLiff();
    </script>
</body>
</html>
